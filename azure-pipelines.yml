trigger:
- azure-1

pool:
  name: Default

variables:
  buildConfiguration: Release
  appVersion: v6

stages:

# =========================================================
# STAGE 1: BUILD + SONAR (MSBUILD MODE – NON BLOCKING)
# =========================================================
- stage: BuildAndQuality
  displayName: 'Build & SonarQube (.NET)'
  jobs:
  - job: BuildJob
    displayName: 'Build .NET with Sonar'
    steps:
    - checkout: self

    # ---------- Install SonarScanner ----------
    - script: |
        dotnet tool install --global dotnet-sonarscanner || true
      displayName: 'Install SonarScanner for .NET'

    # ---------- SONAR BEGIN ----------
    - script: |
        export DOTNET_ROOT=/usr/share/dotnet
        export PATH=$DOTNET_ROOT:$PATH:$HOME/.dotnet/tools
        export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1

        dotnet sonarscanner begin \
          /k:"devsecops-dotnet" \
          /n:"DevSecOps .NET App" \
          /d:sonar.host.url="http://localhost:9000" \
          /d:sonar.token="$(SONAR_TOKEN)"
      displayName: 'SonarQube Begin (Non-blocking)'
      continueOnError: true

    # ---------- BUILD ----------
    - script: |
        echo "Building version $(appVersion)"
        cd dotnet-app

        dotnet restore
        dotnet build --configuration $(buildConfiguration)

        dotnet publish \
          --configuration $(buildConfiguration) \
          --output $(Build.ArtifactStagingDirectory)/dotnet/$(appVersion)
      displayName: 'Build & Publish .NET App'

    # ---------- SONAR END ----------
    - script: |
        export DOTNET_ROOT=/usr/share/dotnet
        export PATH=$DOTNET_ROOT:$PATH:$HOME/.dotnet/tools
        export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1

        dotnet sonarscanner end \
          /d:sonar.token="$(SONAR_TOKEN)"
      displayName: 'SonarQube End'
      continueOnError: true

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: dotnet-artifacts
      displayName: 'Publish Build Artifacts'

# =========================================================
# STAGE 2: SECURITY SCAN (OWASP – VISIBILITY ONLY)
# =========================================================
- stage: SecurityScan
  displayName: 'OWASP Dependency Check'
  dependsOn: BuildAndQuality
  jobs:
  - job: OwaspJob
    displayName: 'OWASP Scan'
    steps:
    - checkout: self

    - script: |
        echo "Installing OWASP Dependency Check"

        OWASP_DIR=$HOME/owasp
        mkdir -p $OWASP_DIR
        cd $OWASP_DIR

        if [ ! -d "dependency-check" ]; then
          curl -L -o dc.zip https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip -o dc.zip
          mv dependency-check-9.0.9 dependency-check
        fi

        echo "Running OWASP Dependency Check (non-blocking)"

        mkdir -p $(Build.ArtifactStagingDirectory)/owasp-report

        $OWASP_DIR/dependency-check/bin/dependency-check.sh \
          --scan $(Build.SourcesDirectory) \
          --format HTML \
          --nvdApiKey $(NVD_API_KEY) \
          --out $(Build.ArtifactStagingDirectory)/owasp-report \
          --data "$(Pipeline.Workspace)/dependency-check-data" \
          --failOnCVSS 7
          || true
      displayName: 'Run OWASP Scan'
      continueOnError: true

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)/owasp-report
        artifactName: owasp-report
      displayName: 'Publish OWASP Report'
      continueOnError: true

# =========================================================
# STAGE 3: DEPLOY WITH AUTO ROLLBACK (RUNTIME ONLY)
# =========================================================
- stage: Deploy
  displayName: 'Deploy with Rollback'
  dependsOn: SecurityScan
  jobs:
  - job: DeployJob
    displayName: 'Deploy .NET App'
    steps:
    - download: current
      artifact: dotnet-artifacts

    - script: |
        set +e

        APP_BASE=$HOME/apps/dotnet
        NEW_VERSION=$(appVersion)

        echo "Deploying new version: $NEW_VERSION"

        mkdir -p $APP_BASE/$NEW_VERSION

        cp -r $(Pipeline.Workspace)/dotnet-artifacts/dotnet/$NEW_VERSION/* \
          $APP_BASE/$NEW_VERSION/

        PREVIOUS_VERSION=$(readlink $APP_BASE/current | xargs basename 2>/dev/null)

        ln -sfn $APP_BASE/$NEW_VERSION $APP_BASE/current

        pkill -f dotnet-app.dll || true

        nohup dotnet $APP_BASE/current/dotnet-app.dll \
          --urls=http://0.0.0.0:5000 \
          > $APP_BASE/dotnet.log 2>&1 &

        sleep 5

        echo "Running runtime health check..."
        curl -f http://localhost:5000/WeatherForecast

        echo "✅ Deployment successful"
      displayName: 'Deploy New Version'