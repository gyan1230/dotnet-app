trigger:
- main

pool:
  name: Default
variables:
  buildConfiguration: Release

steps:
# ---------------- CHECKOUT ----------------
- checkout: self

# ---------------- VERIFY AGENT ----------------
- script: |
    echo "Agent info:"
    hostname
    whoami
    dotnet --version
    echo "Sources Directory: $(Build.SourcesDirectory)"
    echo "Artifact Directory: $(Build.ArtifactStagingDirectory)"
  displayName: 'Verify agent & environment'

# ---------------- DOTNET BUILD ----------------
- script: |
    cd dotnet-app
    dotnet restore
    dotnet build --configuration $(buildConfiguration)
    dotnet publish \
      --configuration $(buildConfiguration) \
      --output $(Build.ArtifactStagingDirectory)/dotnet
  displayName: 'Build & Publish .NET App'

- script: |
    echo "Listing repo root:"
    ls -la $(Build.SourcesDirectory)
  displayName: 'DEBUG: Repo structure'

# ---------------- OWASP DEPENDENCY CHECK ----------------
- script: |
    echo "Running OWASP Dependency Check (NVD updates disabled for POC)"

    mkdir -p $(Build.ArtifactStagingDirectory)/owasp
    cd $(Build.SourcesDirectory)

    curl -Ls https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip -o dc.zip
    unzip -q dc.zip

    ./dependency-check/bin/dependency-check.sh \
      --scan $(Build.SourcesDirectory) \
      --format HTML \
      --out $(Build.ArtifactStagingDirectory)/owasp \
      --failOnCVSS 7 \
      --nvdApiDelay 0 \
      --disableAssembly \
      --disableNodeJS \
      --disablePython \
      --disableRuby \
      --disableNvdUpdate
  displayName: 'OWASP Dependency Check (.NET - POC mode)'


# ---------------- PUBLISH ARTIFACTS ----------------
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)
    artifactName: dotnet-build-and-security
  displayName: 'Publish Build & OWASP Artifacts'
