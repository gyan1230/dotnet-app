trigger:
- azure-1

pool:
  name: Default

variables:
  buildConfiguration: Release
  appVersion: v3

stages:

# =========================================================
# STAGE 1: BUILD
# =========================================================
- stage: Build
  displayName: 'Build .NET App'
  jobs:
  - job: BuildDotNet
    steps:
    - checkout: self

    - script: |
        cd dotnet-app
        dotnet restore
        dotnet build --configuration $(buildConfiguration)
        dotnet publish \
          --configuration $(buildConfiguration) \
          --output $(Build.ArtifactStagingDirectory)/dotnet/$(appVersion)
      displayName: 'Build .NET App $(appVersion)'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: dotnet-artifacts
      displayName: 'Publish Artifacts'

# =========================================================
# STAGE 2: DEPLOY
# =========================================================
- stage: Deploy
  displayName: 'Deploy & Rollback'
  dependsOn: Build
  jobs:
  - job: DeployDotNet
    displayName: 'Deploy .NET'
    steps:

    - download: current
      artifact: dotnet-artifacts

    - script: |
        echo "Deploying .NET app version $(appVersion)"

        APP_BASE=$HOME/apps/dotnet
        VERSION=$(appVersion)

        echo "Preparing version directory"
        rm -rf $APP_BASE/$VERSION
        mkdir -p $APP_BASE/$VERSION

        echo "Copying published artifacts"
        cp -r $(Pipeline.Workspace)/dotnet-artifacts/dotnet/$VERSION/* \
          $APP_BASE/$VERSION/

        echo "Deployed files:"
        ls -l $APP_BASE/$VERSION

        echo "Switching current symlink"
        ln -sfn $APP_BASE/$VERSION $APP_BASE/current

        echo "Stopping old process"
        pkill -f dotnet-app.dll || true

        echo "Starting application"
        nohup dotnet $APP_BASE/current/dotnet-app.dll \
          --urls http://0.0.0.0:5000 \
          > $APP_BASE/dotnet.log 2>&1 &

        sleep 5

        echo "Health check"
        curl http://localhost:5000/weatherforecast
      displayName: 'Deploy version $(appVersion)'