trigger:
- main

pool:
  name: Default
variables:
  buildConfiguration: Release

steps:
# ---------------- CHECKOUT ----------------
- checkout: self

# ---------------- VERIFY AGENT ----------------
- script: |
    echo "Agent info:"
    hostname
    whoami
    dotnet --version
    java -version
    mvn -version
  displayName: 'Verify agent & tools'

# ---------------- DOTNET BUILD ----------------
- script: |
    cd dotnet-app
    dotnet restore
    dotnet build --configuration $(buildConfiguration)
    dotnet publish \
      --configuration $(buildConfiguration) \
      --output $(Build.ArtifactStagingDirectory)/dotnet
  displayName: 'Build & Publish .NET App'

# ---------------- JAVA BUILD ----------------
- script: |
    cd java-app
    mvn clean package -DskipTests
    mkdir -p $(Build.ArtifactStagingDirectory)/java
    cp target/*.jar $(Build.ArtifactStagingDirectory)/java/
  displayName: 'Build & Package Java App'


# ---------------- DEPLOY DOTNET APP ----------------
- script: |
    echo "Deploying .NET app on same agent"

    pkill -f dotnet-app.dll || true

    nohup dotnet $(Build.ArtifactStagingDirectory)/dotnet/dotnet-app.dll \
      > dotnet.log 2>&1 &

    sleep 5
    curl http://localhost:5000/weatherforecast
  displayName: 'Deploy & Verify .NET App'

# ---------------- DEPLOY JAVA APP ----------------
- script: |
    echo "Deploying Java app on same agent"

    pkill -f java-app || true

    nohup java -jar $(Build.ArtifactStagingDirectory)/java/*.jar \
      > java.log 2>&1 &

    sleep 5
    curl http://localhost:8080/
  displayName: 'Deploy & Verify Java App'

# ---------------- PUBLISH ARTIFACTS ----------------
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)
    artifactName: app-build-artifacts
  displayName: 'Publish Build Artifacts'