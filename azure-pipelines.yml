trigger:
- azure-1

pool:
  name: Default

variables:
  buildConfiguration: Release
  appVersion: v4

stages:

# =========================================================
# STAGE 1: BUILD
# =========================================================
- stage: Build
  displayName: 'Build .NET App'
  jobs:
  - job: BuildDotNet
    steps:
    - checkout: self

    - script: |
        cd dotnet-app
        dotnet restore
        dotnet build --configuration $(buildConfiguration)
        dotnet publish \
          --configuration $(buildConfiguration) \
          --output $(Build.ArtifactStagingDirectory)/dotnet/$(appVersion)
      displayName: 'Build .NET App $(appVersion)'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: dotnet-artifacts
      displayName: 'Publish Artifacts'

# =========================================================
# STAGE 2: DEPLOY
# =========================================================
- stage: Deploy
  displayName: 'Deploy & Rollback'
  dependsOn: Build
  jobs:
  - job: DeployDotNet
    displayName: 'Deploy .NET'
    steps:

    - download: current
      artifact: dotnet-artifacts

    - script: |
        set -e

        APP_BASE=$HOME/apps/dotnet
        NEW_VERSION=$(appVersion)
        PREVIOUS_VERSION=$(ls -d $APP_BASE/v* | sort | tail -n 2 | head -n 1 | xargs basename)

        echo "Previous version: $PREVIOUS_VERSION"
        echo "Deploying new version: $NEW_VERSION"

        # Prepare new version
        rm -rf $APP_BASE/$NEW_VERSION
        mkdir -p $APP_BASE/$NEW_VERSION

        cp -r $(Pipeline.Workspace)/dotnet-artifacts/dotnet/$NEW_VERSION/* \
          $APP_BASE/$NEW_VERSION/

        # Switch to new version
        ln -sfn $APP_BASE/$NEW_VERSION $APP_BASE/current

        pkill -f dotnet-app.dll || true

        nohup dotnet $APP_BASE/current/dotnet-app.dll \
          --urls http://0.0.0.0:5000 \
          > $APP_BASE/dotnet.log 2>&1 &

        sleep 5

        echo "Running health check..."
        if curl -f http://localhost:5000/weatherforecast; then
          echo "✅ Deployment successful"
        else
          echo "❌ Health check failed — rolling back"

          ln -sfn $APP_BASE/$PREVIOUS_VERSION $APP_BASE/current
          pkill -f dotnet-app.dll || true

          nohup dotnet $APP_BASE/current/dotnet-app.dll \
            --urls http://0.0.0.0:5000 \
            > $APP_BASE/dotnet.log 2>&1 &

          exit 1
        fi
      displayName: 'Deploy with Auto Rollback'
