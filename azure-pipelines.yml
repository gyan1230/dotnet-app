trigger:
- main

pool:
  name: Default

variables:
  buildConfiguration: Release

stages:

# =========================================================
# STAGE 1: BUILD
# =========================================================
- stage: Build
  displayName: 'Build Applications'
  jobs:
  - job: BuildJob
    displayName: 'Build .NET & Java'
    steps:

    - checkout: self

    - script: |
        echo "Agent info:"
        hostname
        whoami
        dotnet --version
        java -version
        mvn -version
      displayName: 'Verify agent & tools'

    # -------- DOTNET BUILD --------
    - script: |
        cd dotnet-app
        dotnet restore
        dotnet build --configuration $(buildConfiguration)
        dotnet publish \
          --configuration $(buildConfiguration) \
          --output $(Build.ArtifactStagingDirectory)/dotnet
      displayName: 'Build & Publish .NET App'

    # -------- JAVA BUILD --------
    - script: |
        cd java-app
        mvn clean package -DskipTests
        mkdir -p $(Build.ArtifactStagingDirectory)/java
        cp target/*.jar $(Build.ArtifactStagingDirectory)/java/
      displayName: 'Build & Package Java App'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: app-build-artifacts
      displayName: 'Publish Build Artifacts'


# =========================================================
# STAGE 2: CODE QUALITY (SONARQUBE)
# =========================================================
- stage: CodeQuality
  displayName: 'SonarQube Analysis'
  dependsOn: Build
  jobs:
  - job: SonarJob
    displayName: 'Run SonarQube Scan'
    steps:

    - checkout: self

    - task: SonarQubePrepare@7
      inputs:
        SonarQube: 'SonarQubeServiceConnection'
        scannerMode: 'dotnet'
        configMode: 'manual'
        projectKey: 'devsecops-poc_devsecops-dotnet_AZwS4g2W832okabp_S1E'
        projectName: 'devsecops-dotnet'
      displayName: 'Prepare SonarQube Analysis'

    - task: SonarQubeAnalyze@7
      displayName: 'Run SonarQube Analysis'

    - task: SonarQubePublish@7
      inputs:
        pollingTimeoutSec: '300'
      displayName: 'Publish Quality Gate Result'


# =========================================================
# STAGE 3: DEPLOY (SAME AGENT â€“ POC)
# =========================================================
- stage: Deploy
  displayName: 'Deploy Applications'
  dependsOn: CodeQuality
  jobs:
  - job: DeployJob
    displayName: 'Deploy .NET & Java'
    steps:

    - download: current
      artifact: app-build-artifacts

    # -------- DEPLOY DOTNET --------
    - script: |
        echo "Deploying .NET app"

        pkill -f dotnet-app.dll || true

        nohup dotnet $(Pipeline.Workspace)/app-build-artifacts/dotnet/dotnet-app.dll \
          > dotnet.log 2>&1 &

        sleep 5
        curl http://localhost:5000/weatherforecast
      displayName: 'Deploy & Verify .NET App'

    # -------- DEPLOY JAVA --------
    - script: |
        echo "Deploying Java app"

        pkill -f java || true

        nohup java -jar $(Pipeline.Workspace)/app-build-artifacts/java/*.jar \
          > java.log 2>&1 &

        sleep 5
        curl http://localhost:8080/
      displayName: 'Deploy & Verify Java App'